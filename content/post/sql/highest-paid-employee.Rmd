---
title: Highest Paid Employee
description: What employee has the highest salary in employees.salaries
subtitle: > 
  Write a query to find the active employee with the highest salary in the employees database.
abstract: > 
  The employees database contains the historical salaries table of employees (former and current) and associated salaries. There is a necessity to query this table to find the current highest-paid active employee and return the employees salary, first and last name.
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      error = TRUE, 
                      max.print = NA, 
                      connection = "mariadb_con")
```


```{r libraries, include = FALSE}
library(DBI)
library(knitr)
library(RMariaDB)
```

```{r db-con_params, include = FALSE}
mariadb.host <- Sys.getenv("mariadb.host")
mariadb.user <- Sys.getenv("mariadb.user")
mariadb.password <- Sys.getenv("mariadb.password")
```

```{r db-con, include = FALSE}
mariadb_con <- dbConnect(RMariaDB::MariaDB(), 
                 host = mariadb.host,
                 user = mariadb.user, 
                 password = mariadb.password)
```

Using [employees](https://dev.mysql.com/doc/employee/en/) database, we need to find the highest-paid employee in our database. 

With this particular database we have to be careful about making assumptions of our data, some of which would be:

  * Only one salary record per employee
  
  * All salary records are current
  
  * Maximum salary is the current salary

If our `salaries` table only consists of current employees and current salary information, then we can do a simple SELECT MAX query and be done. Our `salaries` table is a historical table; we have multiple salary records per employee. 

Additionally, there is no guarantee every employee is an active employee. 

We also cannot assume that the maximum salary is the current salary. 

Let's look at employee 10001 to start:

```{sql use-employees}
USE `employees`;
```

```{sql select-salaries-10001}
SELECT *
FROM `salaries`
WHERE `emp_no` = 10001;
```

By and large, `salary` seems to increase over time. This is incorrect. Notice the salary from dates 2000-06-22 and 2001-06-22; there is a slight decrease. The assumption the max salary would also be the latest salary would be incorrect in this case. 

Let's therefore assume that when asked to get the highest salary in our table that 

  1. The employee must be active
  
  2. The maximum salary applies to current values only
  
We can resolve both of these by finding where `to_date` is "9999-01-01".

With that and ordering on `salary` descending, we can find our current maximum salary in the table.

```{sql max-salary}
SELECT `emp_no`, 
  `salary`
FROM `salaries`
WHERE `to_date` = "9999-01-01"
ORDER BY `salary` DESC 
LIMIT 1;
```

I'm asked to find employee but have only returned `emp_no`. I'll JOIN `employees` to get the employees first and last name.

```{sql max-salary-with-employees}
SELECT `salaries`.`emp_no`, 
  `salaries`.`salary`, 
  `employees`.`first_name`, 
  `employees`.`last_name`
FROM `salaries` 
LEFT JOIN `employees`
ON `employees`.`emp_no` = `salaries`.`emp_no`
WHERE `to_date` = "9999-01-01"
ORDER BY `salary` DESC 
LIMIT 1;
```

### MariaDB Server Info

```{sql mariadb-version, connection = mariadb_con, tab.cap = "MariaDB Server Info"}
SELECT @@version_comment AS `Version`, 
  @@version_compile_machine AS `Version Compile Machine`, 
  @@innodb_version AS `InnoDB Version`, 
  @@version_compile_os AS `Version Compile OS`;
```

```{r close-mariadb, include = FALSE}
# Disconnect MariaDB
dbDisconnect(mariadb_con)
```
