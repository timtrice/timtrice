---
title: Hurricane Harvey Post Storm Report (Houston)
author: ~
date: '2017-09-06'
slug: hurricane-harvey-post-storm-report-houston
categories: [r, hurricanes, harvey]
tags: [r, hurricanes, harvey]
---

```{r libraries, message = FALSE}
library(dplyr)
library(ggplot2)
library(ggrepel)
library(knitr)
library(lubridate)
library(plotly)
library(purrr)
library(rrricanes)
library(stringr)
library(tibble)
library(tidyr)
```

Per the National Weather Service in Houston, TX, the following data are preliminary results from Hurricane Harvey:

> THE DATA SHOWN HERE ARE PRELIMINARY....AND SUBJECT TO UPDATES AND CORRECTIONS AS APPROPRIATE.

> THIS REPORT INCLUDES EVENTS OCCURRING WHEN WATCHES AND/OR WARNINGS WERE IN EFFECT...OR WHEN SIGNIFICANT FLOODING ASSOCIATED WITH HARVEY OR ITS REMNANTS WAS AFFECTING THE AREA.

> COUNTIES INCLUDED...MADISON...MADISON...WALKER...BRAZOS...GRIMES...MONTGOMERY...SAN JACINTO...POLK...WASHINGTON...BURLESON...WALLER...HARRIS...LIBERTY...AUSTIN...COLORADO...WHARTON...FORT BEND...JACKSON...MATAGORDA...BRAZORIA...GALVESTON...CHAMBERS...TRINITY

```{r data}
# Load raw data
rpt <- "https://nwschat.weather.gov/p.php?pid=201709062030-KHGX-ACUS74-PSHHGX"
txt <- readLines(rpt)

# Set base plot
bp <- al_tracking_chart(color = "black", fill = "white", size = 0.1, res = 50)
```

## Lowest SLP, Maximum Sustained Winds and Gusts

```{r slp}
# subset section A
sec_a <- txt[grep("^A\\. LOWEST SEA LEVEL PRESSURE", txt):(grep("^B\\. MARINE OBSERVATIONS", txt) - 1)]
# trim head
sec_a <- sec_a[-c(1:9)]
# trim tail
sec_a <- head(sec_a, n = -4L)

# subset section B
sec_b <- txt[grep("^B\\. MARINE OBSERVATIONS", txt):(grep("^C\\. STORM TOTAL RAINFALL", txt) - 1)]
# trim head
sec_b <- sec_b[-c(1:8)]
# trim tail
sec_b <- head(sec_b, n = -5L)

# Bind to sec
sec <- c(sec_a, sec_b)

# There is a subheader in middle I'll also manually remove
sec <- sec[-c(78:88)]

# Get station header data
stations <- str_match(sec, 
                      sprintf("^%s[\\s-]*?%s[\\s-]*?%s[\\s]+$", 
                              "([[K|X|J|4]\\w]{3,5})",   # Station
                              "([\\w\\s/\\.\\(\\)]+)",       # Location
                              "([\\D]{2})")) %>%             # State
  .[complete.cases(.),]

# Get station obs. I really wanted to expand the regex to do this; use it as 
# a learning opportunity. But, apparently my skills aren't quite that 
# advanced... oh, well
obs <- str_match(sec, "^(\\d{2}\\.\\d{2}.+$)")[,2] %>% .[complete.cases(.)]

# Move to dataframe
slp <- as_data_frame(
  list("Station" = stations[,2], 
       "Location" = stations[,3], 
       "State" = stations[,4], 
       "Lat" = as.numeric(str_sub(obs, 0L, 5L)), 
       "Lon" = as.numeric(str_sub(obs, 7L, 12L)), 
       "MinPres" = as.numeric(str_sub(obs, 16L, 21L)), 
       "MinPresDt" = as.POSIXct(ymd_hm(sprintf("2017-08-%s %s", 
                                               str_sub(obs, 23L, 24L), 
                                               str_sub(obs, 26L, 29L))), 
                               tz = "UTC"), 
       "Remarks" = str_sub(obs, 31L, 31L), 
       "MaxSustDir" = as.numeric(str_sub(obs, 33L, 35L)), 
       "MaxSustSpd" = as.numeric(str_sub(obs, 37L, 39L)),
       "MaxSustDt" = as.POSIXct(ymd_hm(sprintf("2017-08-%s %s", 
                                               str_sub(obs, 42L, 43L), 
                                               str_sub(obs, 45L, 48L))), 
                               tz = "UTC"), 
       "PeakGustDir" = as.numeric(str_sub(obs, 52L, 54L)), 
       "PeakGustSpd" = as.numeric(str_sub(obs, 56L, 58L)),
       "PeakGustDt" = as.POSIXct(ymd_hm(sprintf("2017-08-%s %s", 
                                                str_sub(obs, 60L, 61L), 
                                                str_sub(obs, 63L, 66L))), 
                               tz = "UTC"))) %>% 
  mutate(Lat = if_else(Lat < 0, Lat * -1, Lat), 
         Lon = if_else(Lon > 0, Lon * -1, Lon))

# Clean up
slp$MinPres[slp$MinPres == 9999.0] <- NA
slp$MaxSustDir[slp$MaxSustDir == 999] <- NA
slp$MaxSustSpd[slp$MaxSustSpd == 999] <- NA
```

```{r slp_plot, message = FALSE, fig.width = 7}
p <- bp + 
  geom_point(data = slp, 
             aes(x = Lon, y = Lat, 
                 text = sprintf("%s\n%s, %s\n%s UTC", 
                                Station, 
                                Location, 
                                State, 
                                MaxSustDt), 
                 size = MaxSustSpd, color = MaxSustSpd)) + 
  coord_equal(xlim = c(min(slp$Lon, na.rm = TRUE), max(slp$Lon, na.rm = TRUE)), 
              ylim = c(min(slp$Lat, na.rm = TRUE), max(slp$Lat, na.rm = TRUE)))

ggplotly(p, tooltip = c("text", "size", "color"))
```

## Storm Total Rainfall

Storm total rainfall from Aug. 25, 12:00 UTC (7:00 AM CDT) through Aug. 31 12:00 UTC (7:00 AM CDT)

```{r rain}
rain_obs <- txt[grep("^C\\. STORM TOTAL RAINFALL", txt):(grep("^D\\. INLAND FLOODING", txt) - 1)]

# Drop header and tail data
rain_obs <- rain_obs[-c(1:6)]
rain_obs <- head(rain_obs, -2L)

# Drop empties
rain_obs <- rain_obs[rain_obs != ""]

# Here I'll get observations first
pos <- str_match(rain_obs, sprintf("^%s[\\s]+%s[\\s]?$", 
                                 "([\\d\\.]{5})", 
                                 "([-\\d\\.]{6})"))
# Remove NAs
pos <- pos[complete.cases(pos),]

# Get location details
loc <- str_match(rain_obs, sprintf("^%s[\\s]{3,}%s[\\s]{3,}%s[\\s]{3,}%s[\\s]+%s$", 
                                   "([\\w\\d\\s\\.\\-/]{1,29})", # Location
                                   "([\\w\\s]{1,20})",           # County
                                   "([\\w\\d-=]*)",         # ID
                                   "([\\d\\.]{3,5})",           # Rainfall
                                   "(I*)")) %>%             # Remarks
  .[complete.cases(.),]

# Make df
rain <- as_data_frame(
  list("Location" = loc[,2], 
       "County" = loc[,3], 
       "ID" = loc[,4], 
       "Rainfall" = as.numeric(loc[,5]), 
       "Remarks" = loc[,6],
       "Lat" = as.numeric(pos[,2]), 
       "Lon" = as.numeric(pos[,3]))) %>% 
  mutate(Lat = if_else(Lat < 0, Lat * -1, Lat), 
         Lon = if_else(Lon > 0, Lon * -1, Lon))
```

```{r rain_plot}
p <- bp + 
  geom_point(data = rain, 
             aes(x = Lon, y = Lat, 
                 text = sprintf("%s\n%s, %s", 
                                ID, 
                                Location, 
                                County), 
                 size = Rainfall, color = Rainfall)) + 
  coord_equal(xlim = c(min(rain$Lon, na.rm = TRUE), max(rain$Lon, na.rm = TRUE)), 
              ylim = c(min(rain$Lat, na.rm = TRUE), max(rain$Lat, na.rm = TRUE)))

ggplotly(p, tooltip = c("text", "size", "color"))
```

## Maximum Storm Surge and Storm Tide

```{r}
tide_obs <- txt[grep("^E\\. MAXIMUM STORM SURGE AND STORM TIDE", txt):(grep("^F\\. TORNADOES", txt) - 1)]
# Trim the edges
tide_obs <- tide_obs[-c(1:7)]
tide_obs <- head(tide_obs, n = -5L)
tide_obs[tide_obs == ""] <- NA
tide_obs <- tide_obs[complete.cases(tide_obs)]

tide <- as_data_frame(
  list("County" = str_trim(str_sub(tide_obs, 0L, 16L)), 
       "Location" = str_trim(str_sub(tide_obs, 18L, 32L)), 
       "Surge" = as.numeric(str_trim(str_sub(tide_obs, 34L, 39L))), 
       "Tide" = as.numeric(str_trim(str_sub(tide_obs, 42L, 46L))), 
       "DateTime" = as.POSIXct(ymd_hm(sprintf("2017-08-%s %s", 
                                              str_sub(tide_obs, 49L, 50L), 
                                              str_sub(tide_obs, 52L, 55L))), 
                               tz = "UTC"), 
       "Erosion" = str_trim(str_sub(tide_obs, 58L, 64L))))
```

```{r tide_table}
kable(tide, caption = "Storm Surge and Storm Tide Totals (ft)")
```

## Tornadoes

```{r}
tor_obs <- txt[grep("^F\\. TORNADOES", txt):(grep("^G\\. STORM IMPACTS BY COUNTY", txt) - 1)]
tor_obs <- tor_obs[-c(1:6)]
tor_obs <- head(tor_obs, n = -3L)

# county, time and tornado scale
loc <- str_match(tor_obs, "^([\\w\\d\\s]{28})\\s+([\\w\\s]{16})\\s+([\\d/]{7})\\s+(EF\\d)\\s+$") %>% 
  .[complete.cases(.),]

# lat, lon
pos <- str_match(tor_obs, "^([\\d\\.]{4,5})\\s+([-\\d\\.]{4,6})$") %>% 
  .[complete.cases(.),]

# Now, get the remarks. Subtract loc and pos to make it easier.
# Essentially, what I'm doing here is joining the vector together 
# with a \t. Consecutive \t's indicate a break between remarks so 
# make that a newline. Then split on \n and trim, return to vector.
rmks <- tor_obs[!(tor_obs %in% c(loc, pos))]
rmks <- str_c(rmks, collapse = "\t")
rmks <- str_replace_all(rmks, "\t\t+", "\n")
rmks <- str_replace_all(rmks, "\t", " ")
rmks <- str_split(rmks, "\n")
rmks <- map(rmks, str_trim, side = "both") %>% flatten_chr()

tors <- as_data_frame(
  list("Location" = loc[,2], 
       "County" = loc[,3], 
       "Date" = as.POSIXct(ymd_hm(sprintf("2017-08-%s %s", 
                                          str_sub(loc[,4], 0L, 2L), 
                                          str_sub(loc[,4], 4L, 7L)))), 
       "Scale" = factor(loc[,5], 
                        levels = c("EF0", "EF1", "EF2", "EF3", "EF4", "EF5"), 
                        labels = c("EF0", "EF1", "EF2", "EF3", "EF4", "EF5")), 
       "Lat" = as.numeric(pos[,2]), 
       "Lon" = as.numeric(pos[,3]), 
       "Remarks" = rmks))
```


| Scale | Wind (mph) | Wind (kts) |
|:-----:|:----------:|:----------:|
| EFO   | 65-85      | 55-74      |
| EF1   | 86-110     | 75-96      |
| EF2   | 111-135    | 97-117     |
| EF3   | 136-165    | 118-143    |
| EF4   | 166-200    | 143-174    |
| EF5   | >200       | >175       |

```{r tor_plot}
tmp <- tors %>% filter(Lat > 0, Lon < 0) # Filter out missing values
p <- bp + 
  geom_point(data = tmp, 
             aes(x = Lon, y = Lat, 
                 text = sprintf("%s", 
                                str_wrap(Remarks)), 
                 size = Scale, color = Scale)) + 
  coord_equal(xlim = c(min(tmp$Lon, na.rm = TRUE), max(tmp$Lon, na.rm = TRUE)), 
              ylim = c(min(tmp$Lat, na.rm = TRUE), max(tmp$Lat, na.rm = TRUE)))

ggplotly(p, tooltip = c("text", "size", "color"))
```

```{r}
kable(tors, caption = "Tornadoes")
```

## Source

[Post Tropical Cyclone Report - Tropical Storm Harvey](https://nwschat.weather.gov/p.php?pid=201709062030-KHGX-ACUS74-PSHHGX)

## Session Info

```{r session_info}
pander::pander(sessionInfo())
```
