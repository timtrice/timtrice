---
title: Hurricane Harvey Post Storm Report
author: ~
date: '2017-09-06'
slug: hurricane-harvey-report
categories: [r, hurricanes, harvey]
tags: [r, hurricanes, harvey]
output:
  blogdown::html_page:
    toc: true
---

In early September, 2017, National Weather Service offices in Brownsville, Corpus Christi, San Antonio, and Houston, Texas, and Lake Charles, Louisiana released preliminary data reports on Hurricane Harvey.

```{r libraries, echo = FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(ggrepel)
library(knitr)
library(lubridate)
library(purrr)
library(stringr)
library(tibble)
```

```{r data, echo = FALSE}
# URLs to reports. These links point to the latest product so the text may 
# change over time. Raw data will be saved in the GitHub repo:
# https://github.com/timtrice/web

if (!(file.exists("data/harvey-post-storm-report.rds"))) {
  rpts <- c(
    "bro" = "ftp://tgftp.nws.noaa.gov/data/raw/ac/acus74.kbro.psh.bro.txt", 
    "crp" = "ftp://tgftp.nws.noaa.gov/data/raw/ac/acus74.kcrp.psh.crp.txt", 
    "ewx" = "ftp://tgftp.nws.noaa.gov/data/raw/ac/acus74.kewx.psh.ewx.txt", 
    "hgx" = "ftp://tgftp.nws.noaa.gov/data/raw/ac/acus74.khgx.psh.hgx.txt", 
    "lch" = "ftp://tgftp.nws.noaa.gov/data/raw/ac/acus74.klch.psh.lch.txt", 
    "lix" = "ftp://tgftp.nws.noaa.gov/data/raw/ac/acus74.klix.psh.lix.txt")
  
  # Read data
  txt <- map(rpts, ~readLines(.x))
  
  # Save data
  saveRDS(txt, file = file.path("data/harvey-post-storm-report.rds"))
  message("ok")
} else {
  txt <- readRDS(file = file.path("data/harvey-post-storm-report.rds"))
}
```

```{r a_b_normalize, echo = FALSE}
## ---- Section A. Lowest Sea Level Pressure ----
## ---- Section B. Marine Obs ----
slp_raw <- c(map(txt, ~.[grep("^A\\.", .):grep("^C\\.", .)])) %>% 
  flatten_chr()

# Get a count of all rows that begin with a latitude followed by longitude. 
# This will tell me exactly how many records I have.
# * \\s between lat and lon may be one or multiple lengths. 
slp_obs_ptn <- "^\\d\\d\\.\\d\\d\\s*-*\\d\\d\\d*\\.\\d\\d.+"
slp_n <- sum(str_count(slp_raw, slp_obs_ptn))

# Get indices of values for n
slp_obs_n <- str_which(slp_raw, slp_obs_ptn)
# The location for the obs will be the line immediatley preceeding it. 
# Therefore, we can get the station data by calculating x - 1
slp_stations_n <- slp_obs_n - 1

# Load stations
# Here, I trim the strings then take the nchar of longest string, round to 
# nearest ten and pad the string. I'll use this to help extract data.
slp_stations <- slp_raw[slp_stations_n] %>% 
  str_trim() %>% 
  str_pad(width = round(max(nchar(.)), digits = -1), side = "right") %>% 
  # Replace first "-" with "\t" to help split ID and Station
  str_replace("\\s*-\\s*", "\t")

# Load observations and trim
slp_obs <- slp_raw[slp_obs_n]

# Combine stations and obs
slp <- str_c(slp_stations, slp_obs)
```

```{r a_b_parse, echo = FALSE}
# Begin extraction.
tmp <- str_match(slp, 
                 sprintf("^%s%s%s%s%s%s%s%s%s%s%s%s$", 
                         # ID-Station
                         "(\\w+)\t*(?<=\t{0,1})(.+)(?=\\s+\\d{2}\\.\\d{2})",
                         # Lat
                         "\\s+(\\d{2}\\.\\d{2})",
                         # Lon
                         "\\s+-*(\\d{2,6}\\.\\d{2})",
                         # Pres
                         "\\s+(\\d{1,4}\\.\\d{1})*",
                         # PresDT
                         "\\s+([\\w/]{1,7})*",
                         # PresRmks
                         "\\s+(I)*",
                         # WindDir, Wind
                         "\\s+(\\w{3})/(\\d{3})", 
                         # Wind DTd (d), WindDThm (hm)
                         "\\s+(\\d{2,3})*/*(\\d{3,4})*", 
                         # WindRmks
                         "\\s+(I)*", 
                         # GustDir, Gust
                         "\\s+(\\w{3})*/*(\\d{3})*", 
                         # GustDTd, GustDThm
                         "\\s+(\\d{2})*/*(\\d{4})*", 
                         # GustRmks
                         "\\s+(I)*")) %>% 
  as_tibble() %>% 
  rename(txt = V1, ID = V2, Station = V3, Lat = V4, Lon = V5, Pres = V6, 
         PresDT = V7, PresRmks = V8, WindDir = V9, Wind = V10, WindDTd = V11, 
         WindDThm = V12, WindRmks = V13, GustDir = V14, Gust = V15, 
         GustDTd = V16, GustDThm = V17, GustRmks = V18)
```

## Plots and Charts

## Tables

## Code

Explain the why you did what you did

### Libraries

```{r ref.label = "libraries", eval = FALSE}
```

### Data

```{r ref.label = "data", eval = FALSE}
```

#### Sea Level Pressure and Marine Observations

Each section has a header.

```
A. LOWEST SEA LEVEL PRESSURE/MAXIMUM SUSTAINED WINDS AND PEAK GUSTS
---------------------------------------------------------------------
METAR OBSERVATIONS...
NOTE: ANEMOMETER HEIGHT IS 10 METERS AND WIND AVERAGING IS 2 MINUTES
---------------------------------------------------------------------
LOCATION  ID    MIN    DATE/     MAX      DATE/     PEAK    DATE/
LAT  LON        PRES   TIME      SUST     TIME      GUST    TIME
DEG DECIMAL     (MB)   (UTC)     (KT)     (UTC)     (KT)    (UTC)
---------------------------------------------------------------------
```

```
B. MARINE OBSERVATIONS...
NOTE: ANEMOMETER HEIGHT IN METERS AND WIND AVERAGING PERIOD IN
MINUTES INDICATED UNDER MAXIMUM SUSTAINED WIND IF KNOWN
---------------------------------------------------------------------
LOCATION  ID    MIN    DATE/     MAX      DATE/     PEAK    DATE/
LAT  LON        PRES   TIME      SUST     TIME      GUST    TIME
DEG DECIMAL     (MB)   (UTC)     (KT)     (UTC)     (KT)    (UTC)
---------------------------------------------------------------------
```

Additionally, a subsection of A exists:

```
NON-METAR OBSERVATIONS... 
NOTE: ANEMOMETER HEIGHT IN METERS AND WIND AVERAGING PERIOD IN
MINUTES INDICATED UNDER MAXIMUM SUSTAINED WIND IF KNOWN
---------------------------------------------------------------------
LOCATION  ID    MIN    DATE/     MAX      DATE/     PEAK    DATE/
LAT  LON        PRES   TIME      SUST     TIME      GUST    TIME
DEG DECIMAL     (MB)   (UTC)     (KT)     (UTC)     (KT)    (UTC)
---------------------------------------------------------------------
```

That is irrelevant and is ignored. 

I loop through the text products and extract both sections A and B by identifying where section C begins. This gives me a start and end index that I can then subset to `slp_raw`. 

From there, I identify all values that begin with a latitude and longitude field; our observations. First I count these values (`slp_n`) so that I know exactly how long my final results will be (and to check progress as I move along, making sure I haven't inadvertently removed anything).

Once I know where the observation indices are (`slp_obs_n`) I can find the station identification by calculating `slp_obs_n - 1`; this gives me `slp_stations_n`. 

Thereafter, I combine both subsets into `slp` which puts stations and observations on one line. 

As a last bit of cleanup, I replace consecutive space characters (`\\s`) with one space and then trim the edges.

```{r ref.label = "a_b_normalize", eval = FALSE}
```

Following are the expected fields that will be retrieved from the results of `slp`.

##### Station ID [`ID`]

1. Hyphen character does not necessarily separate `ID` and `Station`:

```{r}
slp[grep("^TXVC-4", slp)]
```

##### Station [`Station`] *opt*

1. Old data may exist; see this reference to Tropical Storm Cindy:

```{r}
slp[grep("^XDUL", slp)]
```

##### Latitude [`Lat`]

All values are clean. As entirety of event occured in northwestern hemisphere, values should be formatted as `\\d{2}\\.\\d{2}`.

##### Longitude [`Lon`]

All longitude values should be formatted as `-\\d{2,3}\\.\\d{2}`. 

1. Some values are not necessarily negative ("95.17" instead of "-95.17"):

```{r}
slp[grep("^KEFD", slp)][2]
```

2. Some values are just incorrect ("-903202.00"):

```{r}
slp[grep("^KXPY", slp)]
```

##### Minimum Pressure [`Pres`] *opt*

Expected format: `\\d{3,4}\\.\\d{2}`. Value is optional and may be `\\s{5,6}`.

1. Some values may be "0.0" (note the preceeding "N/A" which is also unusual in this dataset):

```{r}
slp[grep("^FADT2", slp)]
```

##### Date/time of pressure observation [`PresDT`] *opt*

If `Pres` is provided, the date/time of that observation is also recorded in `\\d{2}/\\d{4}` format. 

If `Pres` is empty (`\\s{5,6}`), `PresDT` will also be empty.

If `Pres` is "0.0" then `PresDT` contains a "MM" string:

```{r}
slp[grep("^SPLL1", slp)]
```

In some cases, `Pres` may be "9999.0" which is invalid. In these cases, `PresDT` is "/" or "99/9999" (note the optional preceeding "I"; `PresRmks`).

```{r}
slp[grep("^KPKV", slp)]
```

```{r}
slp[grep("^KTXSMILE2", slp)]
```

`PresDT` may also be "N/A":

```{r}
slp[grep("^FADT2", slp)]
```

##### Pressure remarks [`PresRmks`] *opt*

`PresRmks` may precede `PresDT` as stated above. Additionally, it may also exist for valid `Pres` and `PresDT` values:

```{r}
slp[grep("^KCWF", slp)]
```
##### Maximum sustained wind direction [`WindDir`]

Wind direction is formatted as `\\d{3}`. It is the first part of the Wind field string, separated from `Wind` with a "/" character.

1. Some values may be "999":

```{r}
slp[grep("^KTXS33", slp)]
```

2. Some values may also contain "MMM":

```{r}
slp[grep("^LOPL1", slp)]
```

##### Maximum sustained winds (opt) [`Wind`]

Precedes `WindDir` separated by a "/" character.

1. Valid values may be preceeded by invalid `WindDir` values:

```{r}
slp[grep("^FCMP", slp)]
```

It is assumed the observation above is reporting a 88kt wind but from an unrecorded direction.

##### Date/time of winds [`WindDT`]

Same as `PresDT`

##### Wind remarks (opt) [`WindRmks`]

Same as `PresRmks`

##### Peak gust direction [`GustDir`]

Same as `WindDir`

##### Peak Gusts [`Gust`]

Same as `WindDir`

##### Date/time of peak gusts [`GustDT`]

Same as `PresDT`

##### Gust remarks (opt) [`PresRmks`]

Same as `PresRmks`

```{r ref.label = "a_b_parse", eval = FALSE}
```

## Source

[Post Tropical Cyclone Report - Tropical Storm Harvey](https://nwschat.weather.gov/p.php?pid=201709062030-KHGX-ACUS74-PSHHGX)

## Previous Versions

  * [1](https://github.com/timtrice/web/blob/15f552b061a7200647cc2e7bfd8174fec631d816/content/post/2017-09-06-hurricane-harvey-post-storm-report-houston.Rmd)

## Session Info

```{r session_info}
pander::pander(sessionInfo())
```
